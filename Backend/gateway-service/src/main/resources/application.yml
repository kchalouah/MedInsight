server:
  port: 8080

spring:
  application:
    name: gateway-service

  main:
    web-application-type: reactive

  ############################################
  # SPRING CLOUD GATEWAY
  ############################################
  cloud:
    gateway:
      default-filters: []

      routes:
        - id: appointments-route
          uri: lb://appointment-service
          predicates:
            - Path=/api/appointments/**
          filters:
            - StripPrefix=1

        - id: prescriptions-route
          uri: lb://appointment-service
          predicates:
            - Path=/api/prescriptions/**
          filters:
            - StripPrefix=1

        - id: auth-route
          uri: lb://auth-service
          predicates:
            - Path=/api/auth/**
          filters:
            - StripPrefix=1

        - id: admin-route
          uri: lb://auth-service
          predicates:
            - Path=/api/admin/**
          filters:
            - StripPrefix=1

        - id: records-route
          uri: http://medical-record-service:8084
          predicates:
            - Path=/api/records/**
          filters:
            - StripPrefix=1

        - id: audit-route
          uri: http://audit-service:8085
          predicates:
            - Path=/api/audit/**
          filters:
            - StripPrefix=1

        - id: mail-route
          uri: http://mail-service:8087
          predicates:
            - Path=/api/mail/**
          filters:
            - StripPrefix=1

        - id: ml-route
          uri: http://ml-service:8086
          predicates:
            - Path=/api/ml/**
          filters:
            - StripPrefix=1

        - id: medecins-route
          uri: lb://auth-service
          predicates:
            - Path=/api/medecins/**
          filters:
            - StripPrefix=1

        - id: patients-route
          uri: lb://auth-service
          predicates:
            - Path=/api/patients/**
          filters:
            - StripPrefix=1

      ############################################
      # GLOBAL CORS (Gateway-level)
      ############################################
      # (Moved to SecurityConfig.java bean to avoid conflicts)

  ############################################
  # SPRING SECURITY (KEYCLOAK RESOURCE SERVER)
  ############################################
  security:
    oauth2:
      resourceserver:
        jwt:
          issuer-uri: ${KEYCLOAK_ISSUER_URI:http://medinsight.local/realms/medinsight}
          jwk-set-uri: ${KEYCLOAK_JWK_SET_URI:http://keycloak:8080/realms/medinsight/protocol/openid-connect/certs}

############################################
# EUREKA DISCOVERY
############################################
eureka:
  client:
    register-with-eureka: true
    fetch-registry: true
    service-url:
      defaultZone: ${EUREKA_CLIENT_SERVICEURL_DEFAULTZONE:http://discovery-service:8761/eureka/}

  instance:
    prefer-ip-address: true

############################################
# SPRINGDOC / SWAGGER (AGGREGATED)
############################################
springdoc:
  swagger-ui:
    path: /swagger-ui.html
    urls:
      - name: auth-service
        url: /api/auth/v3/api-docs
      - name: appointment-service
        url: /api/appointments/v3/api-docs
      - name: medical-record-service
        url: /api/records/v3/api-docs
      - name: audit-service
        url: /api/audit/v3/api-docs
      - name: mail-service
        url: /api/mail/v3/api-docs
      - name: ml-service
        url: /api/ml/v3/api-docs

  api-docs:
    path: /v3/api-docs

############################################
# ACTUATOR
############################################
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      show-details: always
    prometheus:
      enabled: true

############################################
# CUSTOM APP CONFIG
############################################
app:
  cors:
    allowed-origins:
      - http://localhost:3000
      - http://localhost:3001
      - http://localhost:3002
      - http://localhost:3003

############################################
# LOGGING (VERY USEFUL FOR DEBUG)
############################################
logging:
  level:
    org.springframework.cloud.gateway: DEBUG
    org.springframework.web.reactive: DEBUG
    org.springframework.http.server.reactive: DEBUG
    reactor.netty: DEBUG
    org.springframework.security: DEBUG
