apiVersion: v1
kind: ConfigMap
metadata:
  name: api-test-script
  namespace: medinsight
data:
  test_backend_api.py: |
    import httpx
    import asyncio
    import logging
    import sys
    import random
    import os
    from datetime import datetime, timedelta
    from faker import Faker

    # --- Configuration (Cluster-internal URLs) ---
    GATEWAY_URL = os.getenv("GATEWAY_URL", "http://gateway-service:8080")
    KEYCLOAK_URL = os.getenv("KEYCLOAK_URL", "http://keycloak:8080/realms/medinsight/protocol/openid-connect/token")
    ADMIN_USER = os.getenv("ADMIN_USER", "admin")
    ADMIN_PASS = os.getenv("ADMIN_PASS", "KeycloakAdmin2024!")
    CLIENT_ID = os.getenv("CLIENT_ID", "auth-service")
    CLIENT_SECRET = os.getenv("CLIENT_SECRET", "security-secret")

    # --- Setup Logging ---
    logging.basicConfig(
        level=logging.INFO,
        format='%(asctime)s - %(levelname)s - %(message)s',
        handlers=[logging.StreamHandler(sys.stdout)]
    )
    logger = logging.getLogger("MedInsight-Populator")

    # --- Constants ---
    SPECIALIZATIONS = [
        "Cardiologie", "Dermatologie", "PÃ©diatrie", "MÃ©decine GÃ©nÃ©rale", 
        "Neurologie", "Psychiatrie", "Ophtalmologie", "GynÃ©cologie", "OrthopÃ©die", "Radiologie",
        "Endocrinologie", "Gastro-entÃ©rologie"
    ]

    TUNISIAN_MALE_NAMES = ["Ahmed", "Mohamed", "Ibrahim", "Youssef", "Aziz", "Firas", "Karim", "Walid", "Sami", "Anis"]
    TUNISIAN_FEMALE_NAMES = ["Ameni", "Fatma", "Mariem", "Sarra", "Emna", "Hela", "Noura", "Rym", "Salma", "Yasmine"]
    TUNISIAN_LAST_NAMES = ["Trabelsi", "Gharbi", "Ben Ali", "Jaziri", "Bouazizi", "Hammami", "Dridi", "Mejri", "Saidi"]

    CITIES = ["Tunis", "Sfax", "Sousse", "Bizerte", "GabÃ¨s", "Ariana", "Monastir", "Nabeul", "Kairouan", "Gafsa"]

    class MedInsightDataPopulator:
        def __init__(self):
            self.fake = Faker('fr_FR')
            self.client = httpx.AsyncClient(timeout=30.0)
            self.tokens = {"admin": None}
            self.users = {"doctors": [], "patients": []}

        async def get_admin_token(self):
            data = {
                "grant_type": "password",
                "client_id": CLIENT_ID,
                "client_secret": CLIENT_SECRET,
                "username": ADMIN_USER,
                "password": ADMIN_PASS
            }
            try:
                resp = await self.client.post(KEYCLOAK_URL, data=data)
                if resp.status_code == 200:
                    self.tokens["admin"] = resp.json()['access_token']
                    return True
                logger.error(f"Failed to get admin token: {resp.status_code} - {resp.text}")
            except Exception as e:
                logger.error(f"Connection error: {e}")
            return False

        async def get_user_token(self, email, password):
            data = {
                "grant_type": "password",
                "client_id": CLIENT_ID,
                "client_secret": CLIENT_SECRET,
                "username": email,
                "password": password
            }
            try:
                resp = await self.client.post(KEYCLOAK_URL, data=data)
                if resp.status_code == 200:
                    return resp.json()['access_token']
            except: pass
            return None

        async def create_doctors(self, count=5):
            logger.info(f"--- Creating {count} Doctors ---")
            for _ in range(count):
                first = random.choice(TUNISIAN_MALE_NAMES)
                last = random.choice(TUNISIAN_LAST_NAMES)
                email_prefix = random.randint(100, 999)
                email = f"dr.{email_prefix}.{first.lower()}@medinsight.tn"
                payload = {
                    "email": email, "password": "password123",
                    "firstName": first, "lastName": last, "phoneNumber": "+21620000000",
                    "specialization": random.choice(SPECIALIZATIONS), "licenseNumber": f"TUN-{random.randint(1000,9999)}",
                    "yearsOfExperience": 5, "consultationFee": 60.0
                }
                resp = await self.client.post(f"{GATEWAY_URL}/api/auth/register/medecin", json=payload)
                if resp.status_code in [200, 201]:
                    self.users["doctors"].append({"id": resp.json().get("id"), "email": email, "password": "password123"})
                    logger.info(f"âœ… Created Doctor: {email}")

        async def create_patients(self, count=5):
            logger.info(f"--- Creating {count} Patients ---")
            for _ in range(count):
                first = random.choice(TUNISIAN_FEMALE_NAMES)
                last = random.choice(TUNISIAN_LAST_NAMES)
                email = f"{first.lower()}.{random.randint(100,999)}@example.com"
                payload = {
                    "email": email, "password": "password123",
                    "firstName": first, "lastName": last, "phoneNumber": "+21650000000",
                    "dateOfBirth": "1990-01-01", "gender": "FEMALE"
                }
                resp = await self.client.post(f"{GATEWAY_URL}/api/auth/register/patient", json=payload)
                if resp.status_code in [200, 201]:
                    self.users["patients"].append({"id": resp.json().get("id"), "email": email, "password": "password123"})
                    logger.info(f"âœ… Created Patient: {email}")

        async def run(self):
            logger.info("ðŸš€ Internal Populator Started")
            if await self.get_admin_token():
                logger.info("âœ… Admin logged in")
                await self.create_doctors(5)
                await self.create_patients(5)
            await self.client.aclose()
            logger.info("âœ¨ Done")

    if __name__ == "__main__":
        asyncio.run(MedInsightDataPopulator().run())

---
apiVersion: batch/v1
kind: Job
metadata:
  name: api-test
  namespace: medinsight
spec:
  ttlSecondsAfterFinished: 600
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: api-test
        image: python:3.11-slim
        command: ["/bin/sh", "-c"]
        args:
          - |
            pip install httpx faker --quiet
            python /scripts/test_backend_api.py
        env:
        - name: GATEWAY_URL
          value: "http://gateway-service:8080"
        - name: KEYCLOAK_URL
          value: "http://keycloak:8080/realms/medinsight/protocol/openid-connect/token"
        - name: ADMIN_USER
          value: "admin@medinsight.tn"
        - name: ADMIN_PASS
          value: "Admin123!"
        volumeMounts:
        - name: script
          mountPath: /scripts
      volumes:
      - name: script
        configMap:
          name: api-test-script
