# Auth Service
apiVersion: apps/v1
kind: Deployment
metadata:
  name: auth-service
  namespace: medinsight
spec:
  replicas: 1
  selector:
    matchLabels:
      app: auth-service
  template:
    metadata:
      labels:
        app: auth-service
    spec:
      containers:
      - name: auth-service
        image: <DOCKERHUB_USERNAME>/medinsight-auth-service:latest
        env:
        - name: SPRING_PROFILES_ACTIVE
          value: "docker"
        - name: DB_HOST
          value: "postgres"
        - name: POSTGRES_USER
          valueFrom: { secretKeyRef: { name: db-credentials, key: POSTGRES_USER } }
        - name: POSTGRES_PASSWORD
          valueFrom: { secretKeyRef: { name: db-credentials, key: POSTGRES_PASSWORD } }
        - name: POSTGRES_DB
          valueFrom: { secretKeyRef: { name: db-credentials, key: POSTGRES_DB } }
        - name: KEYCLOAK_URL
          value: "http://keycloak:8080"
        - name: KEYCLOAK_REALM
          value: "medinsight"
        - name: KEYCLOAK_CLIENT_ID
          value: "auth-service"
        - name: KEYCLOAK_CLIENT_SECRET
          value: "auth-service-secret" # Should be in secret
        - name: KEYCLOAK_ADMIN
          valueFrom: { secretKeyRef: { name: keycloak-credentials, key: KEYCLOAK_ADMIN } }
        - name: KEYCLOAK_ADMIN_PASSWORD
          valueFrom: { secretKeyRef: { name: keycloak-credentials, key: KEYCLOAK_ADMIN_PASSWORD } }
        - name: KEYCLOAK_ISSUER_URI
          value: "http://keycloak:8080/realms/medinsight"
        - name: KEYCLOAK_JWK_SET_URI
          value: "http://keycloak:8080/realms/medinsight/protocol/openid-connect/certs"
        - name: EUREKA_CLIENT_SERVICEURL_DEFAULTZONE
          value: "http://discovery-service:8761/eureka/"
        ports:
        - containerPort: 8081
---
apiVersion: v1
kind: Service
metadata:
  name: auth-service
  namespace: medinsight
spec:
  ports:
  - port: 8081
  selector:
    app: auth-service

---
# Gateway Service
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gateway-service
  namespace: medinsight
spec:
  replicas: 1
  selector:
    matchLabels:
      app: gateway-service
  template:
    metadata:
      labels:
        app: gateway-service
    spec:
      containers:
      - name: gateway-service
        image: <DOCKERHUB_USERNAME>/medinsight-gateway-service:latest
        env:
        - name: SPRING_PROFILES_ACTIVE
          value: "docker"
        - name: EUREKA_CLIENT_SERVICEURL_DEFAULTZONE
          value: "http://discovery-service:8761/eureka/"
        - name: SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER_URI
          value: "http://keycloak:8080/realms/medinsight"
        - name: SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_JWK_SET_URI
          value: "http://keycloak:8080/realms/medinsight/protocol/openid-connect/certs"
        ports:
        - containerPort: 8080
---
apiVersion: v1
kind: Service
metadata:
  name: gateway-service
  namespace: medinsight
spec:
  ports:
  - port: 8080
  selector:
    app: gateway-service

---
# Appointment Service
apiVersion: apps/v1
kind: Deployment
metadata:
  name: appointment-service
  namespace: medinsight
spec:
  replicas: 1
  selector:
    matchLabels:
      app: appointment-service
  template:
    metadata:
      labels:
        app: appointment-service
    spec:
      containers:
      - name: appointment-service
        image: <DOCKERHUB_USERNAME>/medinsight-appointment-service:latest
        env:
        - name: SPRING_PROFILES_ACTIVE
          value: "docker"
        - name: DB_HOST
          value: "postgres"
        - name: POSTGRES_USER
          valueFrom: { secretKeyRef: { name: db-credentials, key: POSTGRES_USER } }
        - name: POSTGRES_PASSWORD
          valueFrom: { secretKeyRef: { name: db-credentials, key: POSTGRES_PASSWORD } }
        - name: POSTGRES_DB
          valueFrom: { secretKeyRef: { name: db-credentials, key: POSTGRES_DB } }
        - name: KEYCLOAK_ISSUER_URI
          value: "http://keycloak:8080/realms/medinsight"
        - name: KEYCLOAK_JWK_SET_URI
          value: "http://keycloak:8080/realms/medinsight/protocol/openid-connect/certs"
        - name: EUREKA_CLIENT_SERVICEURL_DEFAULTZONE
          value: "http://discovery-service:8761/eureka/"
        ports:
        - containerPort: 8082
---
apiVersion: v1
kind: Service
metadata:
  name: appointment-service
  namespace: medinsight
spec:
  ports:
  - port: 8082
  selector:
    app: appointment-service

---
# Medical Record Service
apiVersion: apps/v1
kind: Deployment
metadata:
  name: medical-record-service
  namespace: medinsight
spec:
  replicas: 1
  selector:
    matchLabels:
      app: medical-record-service
  template:
    metadata:
      labels:
        app: medical-record-service
    spec:
      containers:
      - name: medical-record-service
        image: <DOCKERHUB_USERNAME>/medinsight-medical-record-service:latest
        env:
        - name: SPRING_PROFILES_ACTIVE
          value: "docker"
        - name: POSTGRES_HOST
          value: "postgres"
        - name: POSTGRES_DB
          valueFrom: { secretKeyRef: { name: db-credentials, key: POSTGRES_DB } }
        - name: POSTGRES_USER
          valueFrom: { secretKeyRef: { name: db-credentials, key: POSTGRES_USER } }
        - name: POSTGRES_PASSWORD
          valueFrom: { secretKeyRef: { name: db-credentials, key: POSTGRES_PASSWORD } }
        - name: KEYCLOAK_ISSUER_URI
          value: "http://keycloak:8080/realms/medinsight"
        - name: EUREKA_URL
          value: "http://discovery-service:8761/eureka/"
        ports:
        - containerPort: 8084
---
apiVersion: v1
kind: Service
metadata:
  name: medical-record-service
  namespace: medinsight
spec:
  ports:
  - port: 8084
  selector:
    app: medical-record-service

---
# Audit Service
apiVersion: apps/v1
kind: Deployment
metadata:
  name: audit-service
  namespace: medinsight
spec:
  replicas: 1
  selector:
    matchLabels:
      app: audit-service
  template:
    metadata:
      labels:
        app: audit-service
    spec:
      containers:
      - name: audit-service
        image: <DOCKERHUB_USERNAME>/medinsight-audit-service:latest
        env:
        - name: SPRING_PROFILES_ACTIVE
          value: "docker"
        - name: SPRING_DATASOURCE_URL
          value: "jdbc:postgresql://postgres:5432/medinsight" # or use env var
        - name: SPRING_DATASOURCE_USERNAME
          valueFrom: { secretKeyRef: { name: db-credentials, key: POSTGRES_USER } }
        - name: SPRING_DATASOURCE_PASSWORD
          valueFrom: { secretKeyRef: { name: db-credentials, key: POSTGRES_PASSWORD } }
        - name: EUREKA_URL
          value: "http://discovery-service:8761/eureka/"
        - name: LOKI_URL
          value: "http://loki:3100/loki/api/v1/push"
        - name: KEYCLOAK_ISSUER_URI
          value: "http://keycloak:8080/realms/medinsight"
        ports:
        - containerPort: 8085
---
apiVersion: v1
kind: Service
metadata:
  name: audit-service
  namespace: medinsight
spec:
  ports:
  - port: 8085
  selector:
    app: audit-service

---
# Mail Service
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mail-service
  namespace: medinsight
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mail-service
  template:
    metadata:
      labels:
        app: mail-service
    spec:
      containers:
      - name: mail-service
        image: <DOCKERHUB_USERNAME>/medinsight-mail-service:latest
        env:
        - name: SPRING_PROFILES_ACTIVE
          value: "docker"
        - name: EUREKA_URL
          value: "http://discovery-service:8761/eureka/"
        - name: SMTP_HOST
          value: "smtp.gmail.com"
        - name: SMTP_PORT
          value: "587"
        - name: SMTP_USERNAME
          value: "PLACEHOLDER_EMAIL"
        - name: SMTP_PASSWORD
          value: "PLACEHOLDER_PASS"
        - name: KEYCLOAK_ISSUER_URI
          value: "http://keycloak:8080/realms/medinsight"
        ports:
        - containerPort: 8087
---
apiVersion: v1
kind: Service
metadata:
  name: mail-service
  namespace: medinsight
spec:
  ports:
  - port: 8087
  selector:
    app: mail-service

---
# ML Service
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ml-service
  namespace: medinsight
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ml-service
  template:
    metadata:
      labels:
        app: ml-service
    spec:
      containers:
      - name: ml-service
        image: <DOCKERHUB_USERNAME>/medinsight-ml-service:latest
        env:
        - name: EUREKA_SERVER_URL
          value: "http://discovery-service:8761/eureka/"
        - name: INSTANCE_HOST
          value: "ml-service"
        - name: KEYCLOAK_ISSUER
          value: "http://keycloak:8080/realms/medinsight"
        ports:
        - containerPort: 8086
---
apiVersion: v1
kind: Service
metadata:
  name: ml-service
  namespace: medinsight
spec:
  ports:
  - port: 8086
  selector:
    app: ml-service
