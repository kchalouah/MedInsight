# Auth Service
apiVersion: apps/v1
kind: Deployment
metadata:
  name: auth-service
  namespace: medinsight
  labels:
    app: auth-service
spec:
  replicas: 1
  selector:
    matchLabels:
      app: auth-service
  template:
    metadata:
      labels:
        app: auth-service
    spec:
      initContainers:
      - name: wait-for-postgres
        image: busybox:1.28
        command: ['sh', '-c', "until nc -z postgres 5432; do echo waiting for postgres; sleep 2; done"]
      - name: wait-for-keycloak
        image: curlimages/curl:8.2.1
        command: ["/bin/sh", "-c"]
        args:
          - |
            until curl -s http://keycloak:8080/realms/medinsight | grep -q 'medinsight'; do
              echo "Waiting for Keycloak..."
              sleep 5
            done
      containers:
      - name: auth-service
        image: kchalouah/medinsight-auth-service:latest
        envFrom:
        - configMapRef:
            name: medinsight-config
        env:
        - name: SPRING_DATASOURCE_USERNAME
          valueFrom: { secretKeyRef: { name: db-credentials, key: POSTGRES_USER } }
        - name: SPRING_DATASOURCE_PASSWORD
          valueFrom: { secretKeyRef: { name: db-credentials, key: POSTGRES_PASSWORD } }
        - name: KEYCLOAK_ADMIN
          valueFrom: { secretKeyRef: { name: keycloak-secrets, key: KEYCLOAK_ADMIN } }
        - name: KEYCLOAK_ADMIN_PASSWORD
          valueFrom: { secretKeyRef: { name: keycloak-secrets, key: KEYCLOAK_ADMIN_PASSWORD } }
        - name: KEYCLOAK_CLIENT_SECRET
          valueFrom: { secretKeyRef: { name: keycloak-secrets, key: KEYCLOAK_CLIENT_SECRET } }
        - name: KEYCLOAK_CLIENT_ID
          value: "auth-service"
        - name: KEYCLOAK_REALM
          value: "medinsight"
        ports:
        - containerPort: 8081
---
apiVersion: v1
kind: Service
metadata:
  name: auth-service
  namespace: medinsight
  labels:
    app: auth-service
spec:
  ports:
  - name: http
    port: 8081
  selector:
    app: auth-service

---
# Gateway Service
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gateway-service
  namespace: medinsight
  labels:
    app: gateway-service
spec:
  replicas: 1
  selector:
    matchLabels:
      app: gateway-service
  template:
    metadata:
      labels:
        app: gateway-service
    spec:
      initContainers:
      - name: wait-for-postgres
        image: busybox:1.28
        command: ['sh', '-c', "until nc -z postgres 5432; do echo waiting for postgres; sleep 2; done"]
      - name: wait-for-keycloak
        image: curlimages/curl:8.2.1
        command: ["/bin/sh", "-c"]
        args:
          - |
            until curl -s http://keycloak:8080/realms/medinsight | grep -q 'medinsight'; do
              echo "Waiting for Keycloak..."
              sleep 5
            done
      containers:
      - name: gateway-service
        image: kchalouah/medinsight-gateway-service:latest
        envFrom:
        - configMapRef:
            name: medinsight-config
        env:
        # Gateway might need explicit mapping if property names differ, but ConfigMap handles standard ones.
        - name: KEYCLOAK_ISSUER_URI
          valueFrom: { configMapKeyRef: { name: medinsight-config, key: KEYCLOAK_ISSUER_URI } }
        - name: KEYCLOAK_JWK_SET_URI
          valueFrom: { configMapKeyRef: { name: medinsight-config, key: KEYCLOAK_JWK_SET_URI } }
        ports:
        - containerPort: 8080
---
apiVersion: v1
kind: Service
metadata:
  name: gateway-service
  namespace: medinsight
  labels:
    app: gateway-service
spec:
  ports:
  - name: http
    port: 8080
  selector:
    app: gateway-service

---
# Appointment Service
apiVersion: apps/v1
kind: Deployment
metadata:
  name: appointment-service
  namespace: medinsight
  labels:
    app: appointment-service
spec:
  replicas: 1
  selector:
    matchLabels:
      app: appointment-service
  template:
    metadata:
      labels:
        app: appointment-service
    spec:
      initContainers:
      - name: wait-for-postgres
        image: busybox:1.28
        command: ['sh', '-c', "until nc -z postgres 5432; do echo waiting for postgres; sleep 2; done"]
      - name: wait-for-keycloak
        image: curlimages/curl:8.2.1
        command: ["/bin/sh", "-c"]
        args:
          - |
            until curl -s http://keycloak:8080/realms/medinsight | grep -q 'medinsight'; do
              echo "Waiting for Keycloak..."
              sleep 5
            done
      containers:
      - name: appointment-service
        image: kchalouah/medinsight-appointment-service:latest
        envFrom:
        - configMapRef:
            name: medinsight-config
        env:
        - name: SPRING_DATASOURCE_USERNAME
          valueFrom: { secretKeyRef: { name: db-credentials, key: POSTGRES_USER } }
        - name: SPRING_DATASOURCE_PASSWORD
          valueFrom: { secretKeyRef: { name: db-credentials, key: POSTGRES_PASSWORD } }
        ports:
        - containerPort: 8082
---
apiVersion: v1
kind: Service
metadata:
  name: appointment-service
  namespace: medinsight
  labels:
    app: appointment-service
spec:
  ports:
  - name: http
    port: 8082
  selector:
    app: appointment-service

---
# Medical Record Service
apiVersion: apps/v1
kind: Deployment
metadata:
  name: medical-record-service
  namespace: medinsight
  labels:
    app: medical-record-service
spec:
  replicas: 1
  selector:
    matchLabels:
      app: medical-record-service
  template:
    metadata:
      labels:
        app: medical-record-service
    spec:
      initContainers:
      - name: wait-for-postgres
        image: busybox:1.28
        command: ['sh', '-c', "until nc -z postgres 5432; do echo waiting for postgres; sleep 2; done"]
      - name: wait-for-keycloak
        image: curlimages/curl:8.2.1
        command: ["/bin/sh", "-c"]
        args:
          - |
            until curl -s http://keycloak:8080/realms/medinsight | grep -q 'medinsight'; do
              echo "Waiting for Keycloak..."
              sleep 5
            done
      containers:
      - name: medical-record-service
        image: kchalouah/medinsight-medical-record-service:latest
        envFrom:
        - configMapRef:
            name: medinsight-config
        env:
        - name: SPRING_DATASOURCE_USERNAME
          valueFrom: { secretKeyRef: { name: db-credentials, key: POSTGRES_USER } }
        - name: SPRING_DATASOURCE_PASSWORD
          valueFrom: { secretKeyRef: { name: db-credentials, key: POSTGRES_PASSWORD } }
        - name: EUREKA_URL
          valueFrom: { configMapKeyRef: { name: medinsight-config, key: EUREKA_CLIENT_SERVICEURL_DEFAULTZONE } }
        ports:
        - containerPort: 8084
---
apiVersion: v1
kind: Service
metadata:
  name: medical-record-service
  namespace: medinsight
  labels:
    app: medical-record-service
spec:
  ports:
  - name: http
    port: 8084
  selector:
    app: medical-record-service

---
# Audit Service
apiVersion: apps/v1
kind: Deployment
metadata:
  name: audit-service
  namespace: medinsight
  labels:
    app: audit-service
spec:
  replicas: 1
  selector:
    matchLabels:
      app: audit-service
  template:
    metadata:
      labels:
        app: audit-service
    spec:
      initContainers:
      - name: wait-for-postgres
        image: busybox:1.28
        command: ['sh', '-c', "until nc -z postgres 5432; do echo waiting for postgres; sleep 2; done"]
      - name: wait-for-keycloak
        image: curlimages/curl:8.2.1
        command: ["/bin/sh", "-c"]
        args:
          - |
            until curl -s http://keycloak:8080/realms/medinsight | grep -q 'medinsight'; do
              echo "Waiting for Keycloak..."
              sleep 5
            done
      containers:
      - name: audit-service
        image: kchalouah/medinsight-audit-service:latest
        envFrom:
        - configMapRef:
            name: medinsight-config
        env:
        - name: SPRING_DATASOURCE_USERNAME
          valueFrom: { secretKeyRef: { name: db-credentials, key: POSTGRES_USER } }
        - name: SPRING_DATASOURCE_PASSWORD
          valueFrom: { secretKeyRef: { name: db-credentials, key: POSTGRES_PASSWORD } }
        - name: EUREKA_URL
          valueFrom: { configMapKeyRef: { name: medinsight-config, key: EUREKA_CLIENT_SERVICEURL_DEFAULTZONE } }
        - name: LOKI_URL
          value: "http://loki:3100/loki/api/v1/push"
        ports:
        - containerPort: 8085
---
apiVersion: v1
kind: Service
metadata:
  name: audit-service
  namespace: medinsight
  labels:
    app: audit-service
spec:
  ports:
  - name: http
    port: 8085
  selector:
    app: audit-service

---
# Mail Service
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mail-service
  namespace: medinsight
  labels:
    app: mail-service
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mail-service
  template:
    metadata:
      labels:
        app: mail-service
    spec:
      initContainers:
      - name: wait-for-postgres
        image: busybox:1.28
        command: ['sh', '-c', "until nc -z postgres 5432; do echo waiting for postgres; sleep 2; done"]
      - name: wait-for-keycloak
        image: curlimages/curl:8.2.1
        command: ["/bin/sh", "-c"]
        args:
          - |
            until curl -s http://keycloak:8080/realms/medinsight | grep -q 'medinsight'; do
              echo "Waiting for Keycloak..."
              sleep 5
            done
      containers:
      - name: mail-service
        image: kchalouah/medinsight-mail-service:latest
        envFrom:
        - configMapRef:
            name: medinsight-config
        env:
        - name: SMTP_USERNAME
          valueFrom: { secretKeyRef: { name: smtp-secrets, key: SMTP_USERNAME } }
        - name: SMTP_PASSWORD
          valueFrom: { secretKeyRef: { name: smtp-secrets, key: SMTP_PASSWORD } }
        - name: EUREKA_URL
          valueFrom: { configMapKeyRef: { name: medinsight-config, key: EUREKA_CLIENT_SERVICEURL_DEFAULTZONE } }
        - name: SMTP_HOST
          value: "smtp.gmail.com"
        - name: SMTP_PORT
          value: "587"
        ports:
        - containerPort: 8087
---
apiVersion: v1
kind: Service
metadata:
  name: mail-service
  namespace: medinsight
  labels:
    app: mail-service
spec:
  ports:
  - name: http
    port: 8087
  selector:
    app: mail-service

---
# ML Service
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ml-service
  namespace: medinsight
  labels:
    app: ml-service
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ml-service
  template:
    metadata:
      labels:
        app: ml-service
    spec:
      initContainers:
      - name: wait-for-postgres
        image: busybox:1.28
        command: ['sh', '-c', "until nc -z postgres 5432; do echo waiting for postgres; sleep 2; done"]
      - name: wait-for-keycloak
        image: curlimages/curl:8.2.1
        command: ["/bin/sh", "-c"]
        args:
          - |
            until curl -s http://keycloak:8080/realms/medinsight | grep -q 'medinsight'; do
              echo "Waiting for Keycloak..."
              sleep 5
            done
      containers:
      - name: ml-service
        image: kchalouah/medinsight-ml-service:latest
        envFrom:
        - configMapRef:
            name: medinsight-config
        env:
        # Override specific names if needed
        - name: EUREKA_SERVER_URL
          valueFrom: { configMapKeyRef: { name: medinsight-config, key: EUREKA_CLIENT_SERVICEURL_DEFAULTZONE } }
        - name: KEYCLOAK_ISSUER
          valueFrom: { configMapKeyRef: { name: medinsight-config, key: KEYCLOAK_ISSUER_URI } }
        - name: INSTANCE_HOST
          value: "ml-service"
        ports:
        - containerPort: 8086
---
apiVersion: v1
kind: Service
metadata:
  name: ml-service
  namespace: medinsight
  labels:
    app: ml-service
spec:
  ports:
  - name: http
    port: 8086
  selector:
    app: ml-service
